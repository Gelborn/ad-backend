name: Deploy Supabase

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      SUPABASE_DB_PASSWORD:  ${{ secrets.SUPABASE_DB_PASSWORD }}
      SUPABASE_REF:          ${{ secrets.SUPABASE_REF }}
      # Build an explicit DB URL so the CLI knows EXACTLY where to push:
      SUPABASE_DB_URL: postgresql://postgres:${{ secrets.SUPABASE_DB_PASSWORD }}@db.${{ secrets.SUPABASE_REF }}.supabase.co:5432/postgres

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Supabase CLI (latest)
        uses: supabase/setup-cli@v1
        with:
          version: latest

      # (Optional) Show where the CLI is pointing
      - name: Print Supabase env
        run: |
          echo "Project ref: $SUPABASE_REF"
          echo "DB host: db.$SUPABASE_REF.supabase.co"

      # Link (writes .supabase/config.toml for function deploys, etc.)
      - name: Link project
        run: |
          supabase link \
            --project-ref "$SUPABASE_REF" \
            --password    "$SUPABASE_DB_PASSWORD"

      # Migrations ‚Äî NON-INTERACTIVE and with explicit DB URL
      - name: Push migrations (non-interactive, explicit DB URL)
        run: |
          supabase db push \
            --non-interactive \
            --db-url "$SUPABASE_DB_URL" \
            --debug

      # Quick verification from CI that the DB really changed (list the last few entries)
      - name: Verify migrations applied
        run: |
          sudo apt-get update && sudo apt-get install -y postgresql-client
          psql "$SUPABASE_DB_URL" -X -v ON_ERROR_STOP=1 -c "
            select version, name, executed_at
            from supabase_migrations.schema_migrations
            order by executed_at desc
            limit 10;
          "

      # Deploy private Edge Functions
      - name: Deploy private Edge Functions
        run: |
          private_fns=(
            cf_create_osc
            cf_create_partnership
            cf_create_restaurant
            cf_match_oscs
            cf_update_favorite
            restaurant_create_donation
            restaurant_release_donation
          )
          for fn in "${private_fns[@]}"; do
            echo "üîê Deploying $fn"
            supabase functions deploy "$fn" \
              --project-ref "$SUPABASE_REF" \
              --import-map supabase/functions/import_map.json
          done

      # Deploy public Edge Functions (no-verify-jwt)
      - name: Deploy public Edge Functions
        run: |
          public_fns=(
            util_cep_info
            osc_accept_donation
            osc_deny_donation
            osc_get_donation_details
            util_send_notifications
          )
          for fn in "${public_fns[@]}"; do
            echo "üåê Deploying $fn (no-verify-jwt)"
            supabase functions deploy "$fn" \
              --project-ref "$SUPABASE_REF" \
              --no-verify-jwt \
              --import-map supabase/functions/import_map.json
          done
