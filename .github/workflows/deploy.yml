name: Deploy Supabase

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      SUPABASE_DB_PASSWORD:  ${{ secrets.SUPABASE_DB_PASSWORD }}
      SUPABASE_REF:          ${{ secrets.SUPABASE_REF }}

    steps:
      # 1 — checkout
      - name: Checkout
        uses: actions/checkout@v3

      # 2 — CLI
      - name: Install Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      # 3 — link
      - name: Link project
        run: |
          supabase link \
            --project-ref "$SUPABASE_REF" \
            --password    "$SUPABASE_DB_PASSWORD"

      # 4 — migrations
      - name: Migrate database
        run: supabase db push

      # 5 — deploy Edge Functions
      - name: Deploy private Edge Functions (JWT verificado)
        run: |
          private_fns=(
            cf_create_osc
            cf_create_restaurant
            cf_send_invite_email
            restaurant_webhook_user_confirmed
            restaurant_liberate_donation
            restaurant_release_donation
            register_restaurant
            util_send_notifications
          )
          for fn in "${private_fns[@]}"; do
            echo "🔐 Deploying $fn"
            supabase functions deploy "$fn"
          done

      - name: Deploy public Edge Functions (--no-verify-jwt)
        run: |
          public_fns=(
            geocode_address
            util_cep_info
            osc_accept_donation
            osc_deny_donation
            osc_get_donation_details
          )
          for fn in "${public_fns[@]}"; do
            echo "🌐 Deploying $fn (no-verify-jwt)"
            supabase functions deploy "$fn" --no-verify-jwt
          done
